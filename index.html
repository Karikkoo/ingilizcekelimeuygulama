<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Çok Yönlü Kelime Uygulaması</title>
    <style>
        :root {
            --primary-color: #007bff; --secondary-color: #6c757d;
            --success-color: #28a745; --warning-color: #ffc107;
            --danger-color: #dc3545; --light-color: #f8f9fa;
            --dark-color: #343a40; --card-height: 200px;
        }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background-color: #e9ecef; color: var(--dark-color); display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 10vh; overflow: auto; /* overflow hidden yerine auto */ }
        .app-container { background-color: var(--light-color); padding: 15px; border-radius: 10px; box-shadow: 0 5px 20px rgba(0,0,0,0.15); width: 95%; max-width: 780px; height: 90vh; max-height: 720px; display: flex; flex-direction: column; overflow: hidden; }
        .app-container h1, .app-container h2 { color: var(--primary-color); text-align: center; margin-top: 0; margin-bottom: 10px; flex-shrink: 0; }
        .tabs { display: flex; margin-bottom: 10px; border-bottom: 2px solid #ddd; flex-shrink: 0; }
        .tab-button { padding: 8px 12px; cursor: pointer; border: none; background-color: transparent; font-size: 0.95em; font-weight: 500; border-bottom: 3px solid transparent; color: var(--secondary-color); }
        .tab-button.active { border-bottom-color: var(--primary-color); color: var(--primary-color); font-weight: bold; }
        .tab-content { display: none; flex-grow: 1; overflow-y: auto; padding-right: 5px; }
        .tab-content.active { display: flex; flex-direction: column; }

        .main-controls-area { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding: 5px; flex-shrink: 0; flex-wrap: wrap; }
        .main-controls-area > div { margin-bottom: 5px; margin-right: 10px; }
        .main-controls-area label { margin-right: 5px; font-size: 0.9em; }
        .main-controls-area select, .main-controls-area input[type="checkbox"] { padding: 5px; border-radius: 4px; border: 1px solid #ccc; font-size: 0.9em; }
        
        .toggle-switch { display: flex; align-items: center; font-size: 0.85em; }
        .toggle-switch label { margin: 0 5px; }
        .switch { position: relative; display: inline-block; width: 50px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 24px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary-color); }
        input:checked + .slider:before { transform: translateX(26px); }

        .flashcard-navigation-wrapper { display: flex; align-items: center; justify-content: center; margin-bottom: 15px; flex-shrink: 0; position: relative; width: 100%; min-height: var(--card-height); }
        .nav-button { background-color: rgba(0,0,0,0.1); border: none; color: var(--dark-color); font-size: 2em; cursor: pointer; padding: 10px 5px; border-radius: 50%; position: absolute; top: 50%; transform: translateY(-50%); z-index: 10; line-height: 1; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; }
        .nav-button:hover { background-color: rgba(0,0,0,0.2); }
        .nav-button:disabled { opacity: 0.3; cursor: not-allowed; }
        #prev-card-button { left: 5px; } #next-card-button { right: 5px; }
        .flashcard-container { perspective: 1000px; width: 75%; max-width: 350px; height: var(--card-height); margin: 0 auto; }
        .flashcard { width: 100%; height: 100%; position: relative; transform-style: preserve-3d; transition: transform 0.6s; cursor: pointer; border: 1px solid #ccc; border-radius: 8px; }
        .flashcard.flipped { transform: rotateY(180deg); }
        .card-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 15px; box-sizing: border-box; border-radius: 8px; font-size: 1.6em; text-align: center; }
        .card-front { background-color: var(--primary-color); color: white; }
        .card-back { background-color: var(--success-color); color: white; transform: rotateY(180deg); font-size: 1.4em; }
        .card-actions-area { text-align: center; margin-bottom: 15px; flex-shrink: 0; }
        .action-button, .form-group button, .btn { padding: 8px 12px; font-size: 0.9em; border: none; border-radius: 5px; cursor: pointer; color: white; transition: background-color 0.3s; background-color: var(--secondary-color); }
        .action-button.learned { background-color: var(--success-color); }
        .form-group button { background-color: var(--primary-color); }
        .btn:hover, .action-button:hover, .form-group button:hover { opacity: 0.85; }
        #current-word-info { font-size: 0.85em; color: #666; text-align: center; margin-bottom:5px; flex-shrink: 0;}
        .form-group { margin-bottom: 10px; }
        .form-group label { display: block; margin-bottom: 3px; font-weight: 500; font-size: 0.9em; }
        .form-group input[type="text"], .form-group textarea, .form-group input[type="email"], .form-group select { width: calc(100% - 18px); padding: 7px; border: 1px solid #ccc; border-radius: 4px; font-size: 0.9em; }
        #no-words-message { text-align: center; padding: 15px; color: #777; font-style: italic; }
        #email-report-output { margin-top:10px; } #email-report-output textarea { width: calc(100% - 18px); min-height: 80px; font-size: 0.85em; }
        .folder-management { margin-top: 15px; padding-top: 10px; border-top: 1px solid #eee;}
        .folder-management input[type="text"] { width: calc(70% - 10px); margin-right: 5px;}
        .folder-management button { width: calc(30% - 10px); font-size:0.85em !important; padding: 7px 5px !important;}
        .test-options button { margin-right: 10px; margin-bottom: 10px; background-color: var(--primary-color); }
        #test-content-area, #test-results { margin-top:10px;}

        /* Test stilleri */
        .question-container {
            background-color: #f0f8ff;
            border: 1px solid #cceeff;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .question-text {
            font-size: 1.1em;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 10px;
        }
        .options-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .options-list li {
            margin-bottom: 8px;
        }
        .options-list label {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-size: 0.95em;
        }
        .options-list input[type="radio"] {
            margin-right: 8px;
            transform: scale(1.1);
        }
        .feedback {
            margin-top: 10px;
            padding: 8px;
            border-radius: 5px;
            font-weight: bold;
        }
        .feedback.correct {
            background-color: #d4edda;
            color: #155724;
        }
        .feedback.incorrect {
            background-color: #f8d7da;
            color: #721c24;
        }

        /* Matching Test Styles */
        .match-container {
            display: flex;
            justify-content: space-around;
            gap: 20px;
            margin-top: 20px;
        }
        .match-column {
            flex: 1;
            border: 2px dashed #ccc;
            padding: 15px;
            min-height: 250px;
            border-radius: 8px;
            background-color: #fdfdff;
        }
        .match-column h3 {
            text-align: center;
            color: var(--dark-color);
            margin-top: 0;
            margin-bottom: 15px;
        }
        .match-item {
            background-color: var(--primary-color);
            color: white;
            padding: 10px 15px;
            margin-bottom: 10px;
            border-radius: 5px;
            cursor: grab;
            text-align: center;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .match-item:hover {
            opacity: 0.9;
        }
        .match-target {
            background-color: #e0f7fa;
            border: 1px solid #b2ebf2;
            padding: 10px;
            min-height: 45px; /* ensure a minimum height for drop */
            margin-bottom: 10px;
            border-radius: 5px;
            text-align: center;
            display: flex; /* Allow dropped item to center */
            align-items: center;
            justify-content: center;
            font-size: 1.1em;
            color: var(--secondary-color);
        }
        .match-target.drag-over {
            background-color: #c0e0e0;
            border-color: #00bcd4;
        }
        .match-target .match-item {
            margin: 0; /* Remove margin when inside target */
        }

    </style>
</head>
<body>
    <div class="app-container">
        <h1>Kelime Uygulamam</h1>

        <div class="tabs">
            <button class="tab-button" data-tab="learnTab">Kelimeler</button>
            <button class="tab-button" data-tab="addWordTab">Kelime Ekle</button>
            <button class="tab-button" data-tab="testTab">Test</button>
            <button class="tab-button" data-tab="settingsTab">Ayarlar & Rapor</button>
        </div>

        <div id="learnTab" class="tab-content">
            <!-- learnTab içeriği -->
             <div class="main-controls-area">
                <div>
                    <label for="folder-select">Klasör:</label>
                    <select id="folder-select" onchange="selectFolder()"></select>
                </div>
                <div class="toggle-switch">
                    <span>TR</span>
                    <label class="switch">
                        <input type="checkbox" id="language-direction-toggle" onchange="toggleLanguageDirection()">
                        <span class="slider"></span>
                    </label>
                    <span>EN</span>
                </div>
                <div class="filter-controls">
                    <label for="filterLearned">Sadece Öğrenmediklerimi Göster:</label>
                    <input type="checkbox" id="filterLearned" onchange="filterWords()">
                </div>
            </div>
            <div id="current-word-info"></div>
            <div id="no-words-message" style="display: none;">Bu klasörde kelime yok veya filtreye uygun kelime bulunamadı.</div>

            <div class="flashcard-navigation-wrapper">
                <button id="prev-card-button" class="nav-button btn" onclick="prevCard()">❮</button>
                <div class="flashcard-container">
                    <div id="flashcard" class="flashcard">
                        <div class="card-face card-front"><span id="card-front-text"></span></div>
                        <div class="card-face card-back"><span id="card-back-text"></span></div>
                    </div>
                </div>
                <button id="next-card-button" class="nav-button btn" onclick="nextCard()">❯</button>
            </div>

            <div class="card-actions-area">
                <button id="toggleLearnedButton" class="action-button">Öğrendim</button>
            </div>
        </div>

        <div id="addWordTab" class="tab-content">
            <!-- addWordTab içeriği -->
            <div class="add-word-form">
                <h3>Yeni Tek Kelime Ekle</h3>
                <div class="form-group">
                    <label for="add-to-folder-select">Eklenecek Klasör:</label>
                    <select id="add-to-folder-select"></select>
                </div>
                <div class="form-group">
                    <label for="new-english-word">İngilizce Kelime:</label>
                    <input type="text" id="new-english-word" required>
                </div>
                <div class="form-group">
                    <label for="new-turkish-word">Türkçe Karşılığı:</label>
                    <input type="text" id="new-turkish-word" required>
                </div>
                <button onclick="addNewWord()" class="btn">Yeni Kelimeyi Ekle</button>
                <hr>
                <h3>Toplu Kelime Ekle (CSV Formatı)</h3>
                 <div class="form-group">
                    <label for="bulk-add-to-folder-select">Eklenecek Klasör:</label>
                    <select id="bulk-add-to-folder-select"></select>
                </div>
                <p style="font-size:0.8em; color: #555;">Her satıra: <code>İngilizce,Türkçe</code><br>(CSV'den içe aktarırken klasör belirtilmemişse seçili klasöre eklenir.)</p>
                <textarea id="bulk-add-words-area" rows="4" placeholder="example,örnek"></textarea>
                <button onclick="addBulkWords()" class="btn">Toplu Kelimeleri Ekle</button>
                
                <div class="folder-management">
                    <h4>Yeni Klasör Oluştur</h4>
                    <input type="text" id="new-folder-name" placeholder="Yeni klasör adı">
                    <button onclick="createNewFolder()" class="btn">Oluştur</button>
                </div>
            </div>
        </div>

        <div id="testTab" class="tab-content">
             <div class="main-controls-area"> <!-- Klasör seçimi test için de geçerli -->
                <div>
                    <label for="test-folder-select">Test Edilecek Klasör:</label>
                    <select id="test-folder-select" onchange="prepareTestData()"></select>
                </div>
            </div>
            <div class="test-area">
                <div class="test-options">
                    <button onclick="startMultipleChoiceTest()" class="btn">Şıklı Test Başlat</button>
                    <button onclick="startMatchingTest()" class="btn">Eşleştirme Testi Başlat</button>
                </div>
                <div id="test-content-area"></div>
                <div id="test-results"></div>
                <button id="submit-test-button" style="display:none; margin-top:10px;" onclick="submitTest()" class="btn">Testi Bitir</button>
            </div>
        </div>

        <div id="settingsTab" class="tab-content">
            <!-- settingsTab içeriği -->
            <div class="settings-area">
                <h3>Raporlama ve Veri</h3>
                <div class="form-group">
                    <label for="email-recipient">Raporu Gönderilecek E-posta Adresi:</label>
                    <input type="email" id="email-recipient" placeholder="ornek@mail.com">
                </div>
                 <div class="form-group">
                    <label for="report-type-select">Rapor Türü:</label>
                    <select id="report-type-select">
                        <option value="all">Tüm Kelimeler (Aktif Klasör)</option>
                        <option value="todayLearned">Bugün Öğrenilenler (Tüm Klasörler)</option>
                    </select>
                </div>
                <button onclick="sendProgressEmail()" class="btn">Öğrenme Raporunu Oluştur</button>
                <div id="email-report-output"></div>
                <hr style="margin: 15px 0;">
                <button onclick="exportVocabularyToCSV()" class="btn" style="margin-right:10px;">Kelimeleri Dışa Aktar (CSV)</button>
                <label class="btn" for="import-file-input" style="display:inline-block; cursor:pointer;">Kelimeleri İçe Aktar (CSV)</label>
                <input type="file" id="import-file-input" accept=".csv,text/csv" onchange="importVocabularyFromCSV(event)" style="display:none;">
                 <hr style="margin: 15px 0;">
                <button onclick="clearAllData()" class="btn" style="background-color: var(--danger-color);">Tüm Verileri Sil</button>
            </div>
        </div>
    </div>

    <script>
        // --- TEMEL AYARLAR VE DEĞİŞKENLER ---
        let vocabularyData = {
            folders: { "Varsayılan": [] },
            activeFolder: "Varsayılan",
            appSettings: {
                currentCardIndex: 0,
                filterLearned: false,
                emailRecipient: "",
                languageDirection: "en-tr"
            }
        };
        let currentCardIndexInView = 0;
        let currentVocabularyView = [];
        let currentTest = null;

        // --- DOM ELEMENTLERİ (DOMContentLoaded içinde atanacak) ---
        let flashcardEl, cardFrontTextEl, cardBackTextEl, prevCardButton, nextCardButton,
            currentWordInfoEl, toggleLearnedButton, filterLearnedCheckbox, noWordsMessageEl,
            folderSelectEl, addToFolderSelectEl, bulkAddToFolderSelectEl, testFolderSelectEl,
            emailRecipientInput, reportTypeSelectEl, emailReportOutputEl, langDirToggleEl,
            testContentArea, testResultsArea, submitTestButton, 
            newFolderNameInputEl, bulkAddWordsAreaEl,
            htmlTabButtons, htmlTabContents; // Değişti: Global tab butonları ve içerikleri

        // --- LOCALSTORAGE & STATE FONKSİYONLARI ---
        const APP_STORAGE_KEY_V3 = 'personalVocabularyApp_v3_fix1'; 

        function saveAppState() {
            try {
                // Sadece appSettings içindeki belirli alanları kaydedin, kelime dizinini değil.
                // currentCardIndex, aktif klasöre özeldir, genel ayar olarak tutulmaz.
                vocabularyData.appSettings.filterLearned = filterLearnedCheckbox ? filterLearnedCheckbox.checked : false;
                vocabularyData.appSettings.emailRecipient = emailRecipientInput ? emailRecipientInput.value : "";
                vocabularyData.appSettings.languageDirection = langDirToggleEl && langDirToggleEl.checked ? "en-tr" : "tr-en"; // Düzeltme
                
                const dataToSave = {
                    folders: vocabularyData.folders,
                    activeFolder: vocabularyData.activeFolder,
                    appSettings: vocabularyData.appSettings
                };
                localStorage.setItem(APP_STORAGE_KEY_V3, JSON.stringify(dataToSave));
            } catch (e) {
                console.error("Uygulama durumu kaydedilirken hata oluştu:", e);
            }
        }

        function loadAppState() {
            try {
                const storedData = localStorage.getItem(APP_STORAGE_KEY_V3);
                if (storedData) {
                    const parsedData = JSON.parse(storedData);
                    vocabularyData.folders = parsedData.folders || { "Varsayılan": [] };
                    vocabularyData.activeFolder = parsedData.activeFolder || "Varsayılan";
                    vocabularyData.appSettings = parsedData.appSettings || {
                        currentCardIndex: 0,
                        filterLearned: false,
                        emailRecipient: "",
                        languageDirection: "en-tr"
                    };

                    // Varsayılan klasör yoksa oluştur
                    if (!vocabularyData.folders["Varsayılan"]) {
                        vocabularyData.folders["Varsayılan"] = [];
                    }

                    // DOM elemanları yüklendiyse değerleri ata
                    if (filterLearnedCheckbox) filterLearnedCheckbox.checked = vocabularyData.appSettings.filterLearned;
                    if (emailRecipientInput) emailRecipientInput.value = vocabularyData.appSettings.emailRecipient;
                    if (langDirToggleEl) {
                        langDirToggleEl.checked = vocabularyData.appSettings.languageDirection === "en-tr";
                    }

                    // Klasör selectbox'larını doldur
                    populateFolderSelects();
                    // Aktif klasörü ayarla
                    if (folderSelectEl) folderSelectEl.value = vocabularyData.activeFolder;
                    if (addToFolderSelectEl) addToFolderSelectEl.value = vocabularyData.activeFolder;
                    if (bulkAddToFolderSelectEl) bulkAddToFolderSelectEl.value = vocabularyData.activeFolder;
                    if (testFolderSelectEl) testFolderSelectEl.value = vocabularyData.activeFolder;

                }
            } catch (e) {
                console.warn("Uygulama durumu yüklenirken hata oluştu veya veri bozuk. Yeni durum başlatılıyor:", e);
                // Hata durumunda veya veri yoksa sıfırdan başla
                vocabularyData = {
                    folders: { "Varsayılan": [] },
                    activeFolder: "Varsayılan",
                    appSettings: {
                        currentCardIndex: 0,
                        filterLearned: false,
                        emailRecipient: "",
                        languageDirection: "en-tr"
                    }
                };
                populateFolderSelects(); // Boş da olsa selectleri doldur
            }
        }

        function clearAllData() {
            if (confirm("Tüm kelimeleri ve uygulama ayarlarını silmek istediğinizden emin misiniz? Bu işlem geri alınamaz!")) {
                localStorage.removeItem(APP_STORAGE_KEY_V3);
                alert("Tüm veriler silindi!");
                location.reload(); // Sayfayı yenileyerek temiz bir başlangıç yap
            }
        }

        function toggleLanguageDirection() { 
            if (!langDirToggleEl) return;
            vocabularyData.appSettings.languageDirection = langDirToggleEl.checked ? "en-tr" : "tr-en";
            saveAppState();
            loadCard(currentCardIndexInView); // Mevcut kartı yeni yönle tekrar yükle
        }

        // --- SEKME YÖNETİMİ (Yeniden Düzenlendi) ---
        function openTab(tabName, clickedButtonElement = null) {
            if (!htmlTabContents || !htmlTabButtons) {
                console.error("Sekme elementleri henüz yüklenmedi!");
                return;
            }
            htmlTabContents.forEach(tc => { tc.style.display = "none"; tc.classList.remove("active"); });
            htmlTabButtons.forEach(tb => tb.classList.remove("active"));

            const activeTabContent = document.getElementById(tabName);
            if (activeTabContent) {
                activeTabContent.style.display = "flex";
                activeTabContent.classList.add("active");
            }

            // Tıklanan butonu veya ID'ye göre bulunan butonu aktif yap
            if (clickedButtonElement) {
                clickedButtonElement.classList.add("active");
            } else {
                htmlTabButtons.forEach(btn => {
                    if (btn.dataset.tab === tabName) { // data-tab attribute'una göre bul
                        btn.classList.add("active");
                    }
                });
            }

            // Her sekme açıldığında selectbox'ları güncelleyelim.
            populateFolderSelects();

            if (tabName === 'learnTab') filterWords(); // Kelimeler sekmesinde filtrelemeyi uygula
            if (tabName === 'testTab') prepareTestData(); // Test sekmesinde test verilerini hazırla
            if (tabName === 'settingsTab' && emailReportOutputEl) emailReportOutputEl.innerHTML = '';
        }


        // --- KELİME KARTI FONKSİYONLARI ---
        function updateCurrentVocabularyView() {
            const activeFolderWords = vocabularyData.folders[vocabularyData.activeFolder] || [];
            if (filterLearnedCheckbox && filterLearnedCheckbox.checked) {
                currentVocabularyView = activeFolderWords.filter(word => !word.isLearned);
            } else {
                currentVocabularyView = [...activeFolderWords];
            }
        }
        
        function displayLearnContent(show) {
            const learnTab = document.getElementById('learnTab');
            if (!learnTab) return;
            // learnTab'in kendisi değil, içindeki belirli alanları toggle et
            const flashcardNavWrapper = learnTab.querySelector('.flashcard-navigation-wrapper');
            const cardActionsArea = learnTab.querySelector('.card-actions-area');

            if(flashcardNavWrapper) flashcardNavWrapper.style.display = show ? '' : 'none';
            if(cardActionsArea) cardActionsArea.style.display = show ? '' : 'none';
            if(currentWordInfoEl) currentWordInfoEl.style.display = show ? '' : 'none'; // Kelime bilgisi de gizlenebilir
            
            if (noWordsMessageEl) noWordsMessageEl.style.display = show ? 'none' : 'block';
        }

        function loadCard(indexInView) {
            updateCurrentVocabularyView(); 
            if (currentVocabularyView.length === 0) {
                displayLearnContent(false);
                if(cardFrontTextEl) cardFrontTextEl.textContent = ''; 
                if(cardBackTextEl) cardBackTextEl.textContent = '';
                if(currentWordInfoEl) currentWordInfoEl.textContent = 'Kelime yok.';
                updateCardNavButtons();
                if (toggleLearnedButton) toggleLearnedButton.disabled = true;
                return;
            }
            displayLearnContent(true);
            if (toggleLearnedButton) toggleLearnedButton.disabled = false;

            if (indexInView < 0) indexInView = 0;
            if (indexInView >= currentVocabularyView.length) indexInView = currentVocabularyView.length - 1;
            currentCardIndexInView = indexInView;

            const item = currentVocabularyView[currentCardIndexInView];
            if (!item) { displayLearnContent(false); return; }

            if (vocabularyData.appSettings.languageDirection === "en-tr") {
                if(cardFrontTextEl) cardFrontTextEl.textContent = item.english; 
                if(cardBackTextEl) cardBackTextEl.textContent = item.turkish;
            } else { 
                if(cardFrontTextEl) cardFrontTextEl.textContent = item.turkish; 
                if(cardBackTextEl) cardBackTextEl.textContent = item.english; 
            }
            if(flashcardEl) flashcardEl.classList.remove('flipped');
            if(currentWordInfoEl) currentWordInfoEl.textContent = `Kelime ${currentCardIndexInView + 1} / ${currentVocabularyView.length}`;
            updateCardNavButtons(); updateToggleLearnedButton(item.isLearned); saveAppState();
        }

        function updateCardNavButtons() { 
            if (!prevCardButton || !nextCardButton) return;
            if (currentVocabularyView.length === 0) {
                prevCardButton.disabled = true; nextCardButton.disabled = true; return;
            }
            prevCardButton.disabled = currentCardIndexInView === 0;
            nextCardButton.disabled = currentCardIndexInView === currentVocabularyView.length - 1;
        }
        function prevCard() { 
            if (currentCardIndexInView > 0) { currentCardIndexInView--; loadCard(currentCardIndexInView); }
        }
        function nextCard() { 
            if (currentCardIndexInView < currentVocabularyView.length - 1) { currentCardIndexInView++; loadCard(currentCardIndexInView); }
        }
        function updateToggleLearnedButton(isLearned) { 
            if (!toggleLearnedButton) return;
            if (isLearned) {
                toggleLearnedButton.textContent = 'Öğrenmedim'; toggleLearnedButton.classList.add('learned');
            } else {
                toggleLearnedButton.textContent = 'Öğrendim'; toggleLearnedButton.classList.remove('learned');
            }
        }
        
        function filterWords() { 
            currentCardIndexInView = 0; 
            updateCurrentVocabularyView();
            loadCard(currentCardIndexInView);
            saveAppState();
        }

        // --- KLASÖR YÖNETİMİ ---
        function populateFolderSelects() {
            const folderNames = Object.keys(vocabularyData.folders);
            // DOM elementlerinin varlığını kontrol et
            const allFolderSelects = [folderSelectEl, addToFolderSelectEl, bulkAddToFolderSelectEl, testFolderSelectEl];
            
            allFolderSelects.forEach(select => {
                if (!select) {
                    // console.warn("Bir select elementi bulunamadı. ID'si kontrol edin."); // Debug amaçlı
                    return;
                }
                const currentSelectedValue = select.value; 
                select.innerHTML = ''; 
                folderNames.forEach(name => {
                    const option = document.createElement('option'); 
                    option.value = name; 
                    option.textContent = name; 
                    select.appendChild(option);
                });
                // Seçili klasörü koru veya varsayılana ayarla
                if (folderNames.includes(currentSelectedValue)) { 
                    select.value = currentSelectedValue; 
                } else if (folderNames.includes(vocabularyData.activeFolder)) { 
                    select.value = vocabularyData.activeFolder; 
                } else if (folderNames.length > 0) { 
                    select.value = folderNames[0]; 
                }
                // Eğer hiç klasör yoksa ve 'Varsayılan' yoksa, onu ekle ve seç
                if (folderNames.length === 0 && !vocabularyData.folders["Varsayılan"]) {
                    vocabularyData.folders["Varsayılan"] = [];
                    const option = document.createElement('option');
                    option.value = "Varsayılan";
                    option.textContent = "Varsayılan";
                    select.appendChild(option);
                    select.value = "Varsayılan";
                    vocabularyData.activeFolder = "Varsayılan";
                    saveAppState(); // Yeni klasörü kaydet
                }
            });
            // Aktif klasör ayarını da güncelle
            if (folderSelectEl) vocabularyData.activeFolder = folderSelectEl.value;
        }


        function createNewFolder() {
            if (!newFolderNameInputEl) { console.error("new-folder-name input not found"); return; }
            const newFolderName = newFolderNameInputEl.value.trim();
            if (!newFolderName) { alert("Klasör adı boş olamaz."); return; }
            if (vocabularyData.folders[newFolderName]) { alert("Bu isimde bir klasör zaten var."); return; }
            
            vocabularyData.folders[newFolderName] = []; 
            vocabularyData.activeFolder = newFolderName; 
            newFolderNameInputEl.value = ''; 
            
            populateFolderSelects(); 
            
            // Tüm selectbox'ları yeni aktif klasöre ayarla
            [folderSelectEl, addToFolderSelectEl, bulkAddToFolderSelectEl, testFolderSelectEl].forEach(sel => { 
                if (sel) sel.value = vocabularyData.activeFolder; 
            });

            updateCurrentVocabularyView(); 
            loadCard(0); 
            saveAppState();
            alert(`"${newFolderName}" klasörü oluşturuldu ve aktif hale getirildi.`);
        }
        function selectFolder() {
            if (!folderSelectEl) return; 
            vocabularyData.activeFolder = folderSelectEl.value;
            // Diğer selectbox'ları da aktif klasörle eşleştir
            [testFolderSelectEl, addToFolderSelectEl, bulkAddToFolderSelectEl].forEach(sel => { 
                if (sel) sel.value = vocabularyData.activeFolder; 
            });
            currentCardIndexInView = 0; 
            updateCurrentVocabularyView(); 
            loadCard(currentCardIndexInView); 
            saveAppState();
        }

        // --- KELİME EKLEME ---
        function addNewWord() {
            if (!addToFolderSelectEl) { console.error("add-to-folder-select not found"); return; }
            const folderName = addToFolderSelectEl.value;
            if (!folderName || !vocabularyData.folders[folderName]) { alert("Lütfen geçerli bir klasör seçin."); return;}

            const newEngInput = document.getElementById('new-english-word');
            const newTurInput = document.getElementById('new-turkish-word');
            if (!newEngInput || !newTurInput) return;

            const newEng = newEngInput.value.trim();
            const newTur = newTurInput.value.trim();
            if (!newEng || !newTur) { alert("İngilizce ve Türkçe alanları zorunludur!"); return; }
            
            if (vocabularyData.folders[folderName].some(word => word.english.toLowerCase() === newEng.toLowerCase())) {
                alert(`"${newEng}" kelimesi "${folderName}" klasöründe zaten var!`); return;
            }
            vocabularyData.folders[folderName].push({ english: newEng, turkish: newTur, isLearned: false });
            
            newEngInput.value = ''; newTurInput.value = '';
            
            if (folderName === vocabularyData.activeFolder) { 
                updateCurrentVocabularyView();
                // Eğer yeni eklenen kelime öğrenilmemişse ve filtre aktif değilse son karta git
                loadCard(filterLearnedCheckbox && filterLearnedCheckbox.checked ? currentCardIndexInView : currentVocabularyView.length - 1); 
            }
            saveAppState();
            alert(`"${newEng}" kelimesi "${folderName}" klasörüne eklendi!`);
        }

        function addBulkWords() {
            if (!bulkAddToFolderSelectEl || !bulkAddWordsAreaEl) { 
                console.error("Toplu ekleme için gerekli DOM elementleri bulunamadı."); return; 
            }
            const folderName = bulkAddToFolderSelectEl.value;
            if (!folderName || !vocabularyData.folders[folderName]) { alert("Lütfen geçerli bir klasör seçin."); return;}

            const bulkText = bulkAddWordsAreaEl.value.trim();
            if (!bulkText) { alert("Lütfen eklenecek kelimeleri girin."); return; }
            const lines = bulkText.split('\n');
            let addedCount = 0; let skippedCount = 0;
            lines.forEach(line => {
                const parts = line.split(',');
                if (parts.length === 2) {
                    const eng = parts[0].trim(); const tur = parts[1].trim();
                    if (eng && tur) {
                        if (!vocabularyData.folders[folderName].some(w => w.english.toLowerCase() === eng.toLowerCase())) {
                            vocabularyData.folders[folderName].push({ english: eng, turkish: tur, isLearned: false });
                            addedCount++;
                        } else { skippedCount++; }
                    }
                }
            });
            if (addedCount > 0) {
                if (folderName === vocabularyData.activeFolder) {
                     updateCurrentVocabularyView(); 
                     filterWords(); // Yeniden filtrele ve kartları yükle
                }
                saveAppState();
            }
            alert(`${addedCount} kelime "${folderName}" klasörüne eklendi. ${skippedCount} kelime atlandı (zaten var veya format hatalı).`);
            bulkAddWordsAreaEl.value = '';
        }
        
        // --- CSV IMPORT/EXPORT ---
        function exportVocabularyToCSV() {
            const currentFolderWords = vocabularyData.folders[vocabularyData.activeFolder] || [];
            if (currentFolderWords.length === 0) {
                alert("Dışa aktarılacak kelime bulunamadı.");
                return;
            }

            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "English,Turkish,IsLearned\n"; // Başlık satırı

            currentFolderWords.forEach(word => {
                let row = `${word.english},${word.turkish},${word.isLearned ? 'true' : 'false'}`;
                csvContent += row + "\n";
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `${vocabularyData.activeFolder}_kelimeler.csv`);
            document.body.appendChild(link); // Firefox için gerekli
            link.click();
            document.body.removeChild(link);
            alert("Kelimeler CSV olarak dışa aktarıldı!");
        }

        function importVocabularyFromCSV(event) {
            const file = event.target.files[0];
            if (!file) {
                alert("Lütfen bir CSV dosyası seçin.");
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                const lines = text.split('\n').filter(line => line.trim() !== ''); // Boş satırları atla
                
                if (lines.length === 0) {
                    alert("CSV dosyasında geçerli veri bulunamadı.");
                    return;
                }

                // Başlık satırını atla (isteğe bağlı, CSV formatına göre değişir)
                // Eğer ilk satır başlık ise: lines.shift();

                let importedCount = 0;
                let skippedCount = 0;

                const targetFolder = vocabularyData.activeFolder; // Şu anki aktif klasöre aktar

                lines.forEach(line => {
                    const parts = line.split(',');
                    // "English,Turkish,IsLearned" veya sadece "English,Turkish" formatını destekle
                    if (parts.length >= 2) {
                        const eng = parts[0].trim();
                        const tur = parts[1].trim();
                        const isLearned = parts.length > 2 ? (parts[2].trim().toLowerCase() === 'true') : false;

                        if (eng && tur) {
                            // Aynı kelimenin zaten var olup olmadığını kontrol et
                            if (!vocabularyData.folders[targetFolder].some(word => word.english.toLowerCase() === eng.toLowerCase())) {
                                vocabularyData.folders[targetFolder].push({ english: eng, turkish: tur, isLearned: isLearned });
                                importedCount++;
                            } else {
                                skippedCount++;
                            }
                        }
                    }
                });

                if (importedCount > 0) {
                    saveAppState();
                    updateCurrentVocabularyView();
                    loadCard(0); // Yeni kelimeler eklendiği için kartları yeniden yükle
                }
                alert(`${importedCount} kelime başarıyla içe aktarıldı. ${skippedCount} kelime atlandı (zaten mevcut veya format hatalı).`);
                event.target.value = ''; // Input'u temizle ki aynı dosya tekrar yüklenebilsin
            };
            reader.readAsText(file);
        }

        // --- AYARLAR, E-POSTA ---
        function sendProgressEmail() {
            if (!emailRecipientInput || !reportTypeSelectEl || !emailReportOutputEl) {
                console.error("Email raporlama için gerekli DOM elementleri bulunamadı.");
                return;
            }
            const recipient = emailRecipientInput.value.trim();
            if (!recipient) {
                alert("Lütfen bir e-posta adresi girin.");
                return;
            }
            if (!/\S+@\S+\.\S+/.test(recipient)) {
                alert("Lütfen geçerli bir e-posta adresi girin.");
                return;
            }

            const reportType = reportTypeSelectEl.value;
            let reportContent = `Sayın ${recipient},\n\nKelime Uygulamanızdan öğrenme raporunuz:\n\n`;

            if (reportType === 'all') {
                const activeFolderWords = vocabularyData.folders[vocabularyData.activeFolder] || [];
                const total = activeFolderWords.length;
                const learned = activeFolderWords.filter(word => word.isLearned).length;
                const unlearned = total - learned;

                reportContent += `Aktif Klasör: "${vocabularyData.activeFolder}"\n`;
                reportContent += `Toplam Kelime Sayısı: ${total}\n`;
                reportContent += `Öğrenilen Kelime Sayısı: ${learned}\n`;
                reportContent += `Öğrenilecek Kelime Sayısı: ${unlearned}\n\n`;

                if (total > 0) {
                    reportContent += "Öğrenilen Kelimeler:\n";
                    activeFolderWords.filter(word => word.isLearned).forEach(word => {
                        reportContent += `- ${word.english} (${word.turkish})\n`;
                    });
                    reportContent += "\nÖğrenilecek Kelimeler:\n";
                    activeFolderWords.filter(word => !word.isLearned).forEach(word => {
                        reportContent += `- ${word.english} (${word.turkish})\n`;
                    });
                } else {
                    reportContent += "Bu klasörde henüz kelime bulunmamaktadır.\n";
                }

            } else if (reportType === 'todayLearned') {
                const today = new Date().toDateString();
                let todayLearnedWords = [];

                for (const folderName in vocabularyData.folders) {
                    vocabularyData.folders[folderName].forEach(word => {
                        if (word.isLearned && word.learnedTimestamp) {
                            const wordLearnedDate = new Date(word.learnedTimestamp).toDateString();
                            if (wordLearnedDate === today) {
                                todayLearnedWords.push({ ...word, folder: folderName });
                            }
                        }
                    });
                }

                reportContent += `Bugün (${today}) Öğrenilen Kelimeler:\n`;
                if (todayLearnedWords.length > 0) {
                    todayLearnedWords.forEach(word => {
                        reportContent += `- ${word.english} (${word.turkish}) [Klasör: ${word.folder}]\n`;
                    });
                } else {
                    reportContent += "Bugün henüz yeni kelime öğrenilmedi.\n";
                }
            }

            emailReportOutputEl.innerHTML = `
                <p>Aşağıdaki raporu kopyalayıp e-posta ile gönderebilirsiniz:</p>
                <textarea readonly>${reportContent}</textarea>
                <button onclick="copyToClipboard(this)" class="btn" style="margin-top:5px;">Panoya Kopyala</button>
            `;
            alert("Rapor oluşturuldu. Lütfen kopyalayıp e-posta uygulamanıza yapıştırın.");
            saveAppState(); // E-posta alıcısını kaydet
        }

        function copyToClipboard(buttonElement) {
            const textarea = buttonElement.previousElementSibling;
            if (textarea) {
                textarea.select();
                textarea.setSelectionRange(0, 99999); // Mobil cihazlar için
                document.execCommand("copy");
                buttonElement.textContent = "Kopyalandı!";
                setTimeout(() => {
                    buttonElement.textContent = "Panoya Kopyala";
                }, 2000);
            }
        }

        // --- KLAVYE KISAYOLLARI ---
        // document.addEventListener('keydown', function(event) { /* ... (önceki gibi) ... */ });

        // --- TEST FONKSİYONLARI ---
        function prepareTestData() { 
            // Seçili klasörün kelimelerini yükle ve testi sıfırla
            if (!testFolderSelectEl) { console.error("test-folder-select not found"); return; }
            vocabularyData.activeFolder = testFolderSelectEl.value; // Test için seçilen klasörü aktif klasör yap

            testContentArea.innerHTML = '';
            testResultsArea.innerHTML = '';
            submitTestButton.style.display = 'none';
            currentTest = null;

            const wordsInActiveFolder = vocabularyData.folders[vocabularyData.activeFolder] || [];
            if (wordsInActiveFolder.length < 2) {
                testContentArea.innerHTML = "<p>Test başlatmak için seçili klasörde en az 2 kelime bulunmalıdır.</p>";
            } else {
                testContentArea.innerHTML = "<p>Lütfen bir test türü seçin.</p>";
            }
            saveAppState(); // Aktif klasör değişikliğini kaydet
        }

        function shuffleArray(array) { 
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function startMultipleChoiceTest(count = 5) {
            if (!testFolderSelectEl) { console.error("test-folder-select not found"); return; }
            const wordsInActiveFolder = vocabularyData.folders[testFolderSelectEl.value] || [];

            testContentArea.innerHTML = '';
            testResultsArea.innerHTML = '';
            submitTestButton.style.display = 'block';
            currentTest = { type: 'multiple-choice', questions: [], score: 0 };

            // Öğrenilmemiş kelimeleri filtrele ve rastgele seç
            const unlearnedWords = wordsInActiveFolder.filter(w => !w.isLearned);
            const wordsToTest = shuffleArray([...unlearnedWords]).slice(0, Math.min(count, unlearnedWords.length)); 
            
            if (wordsToTest.length < 2) {
                testContentArea.innerHTML = "<p>Şıklı test için yeterli öğrenilmemiş kelime (en az 2) bulunmuyor.</p>";
                submitTestButton.style.display = 'none';
                return;
            }

            wordsToTest.forEach((word, index) => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'question-container';
                questionDiv.innerHTML = `<p class="question-text">${index + 1}. "${word.english}" kelimesinin Türkçe karşılığı nedir?</p>`;
                
                let options = [word.turkish];
                // Diğer klasördeki kelimelerden değil, aktif klasördeki diğer kelimelerden al.
                const otherWords = shuffleArray(wordsInActiveFolder.filter(w => w.english !== word.english));
                for (let i = 0; i < Math.min(3, otherWords.length); i++) { 
                    options.push(otherWords[i].turkish);
                }
                options = shuffleArray(options.filter((value, idx, self) => self.indexOf(value) === idx)); // Unique options

                // Eğer seçenek sayısı hala yetersizse, hata oluşmaması için kontrol
                while (options.length < 4 && wordsInActiveFolder.length > options.length) {
                    const randomWord = wordsInActiveFolder[Math.floor(Math.random() * wordsInActiveFolder.length)];
                    if (!options.includes(randomWord.turkish)) {
                        options.push(randomWord.turkish);
                    }
                }
                options = shuffleArray(options); // Seçenekleri tekrar karıştır

                const optionsList = document.createElement('ul');
                optionsList.className = 'options-list';
                options.forEach(opt => {
                    optionsList.innerHTML += `<li><label><input type="radio" name="q${index}" value="${opt}"> ${opt}</label></li>`;
                });
                questionDiv.appendChild(optionsList);
                questionDiv.dataset.correctAnswer = word.turkish;
                testContentArea.appendChild(questionDiv);
                currentTest.questions.push({english: word.english, correctAnswer: word.turkish});
            });
        }
        
        let draggedItem = null; 

        function startMatchingTest(count = 5) {
            if (!testFolderSelectEl) { console.error("test-folder-select not found"); return; }
            const wordsInActiveFolder = vocabularyData.folders[testFolderSelectEl.value] || [];

            testContentArea.innerHTML = '';
            testResultsArea.innerHTML = '';
            submitTestButton.style.display = 'block';
            currentTest = { type: 'matching', pairs: [], score: 0 };

            // Öğrenilmemiş kelimeleri filtrele ve rastgele seç
            const unlearnedWords = wordsInActiveFolder.filter(w => !w.isLearned);
            const wordsToTest = shuffleArray([...unlearnedWords]).slice(0, Math.min(count, unlearnedWords.length)); 
            
            if (wordsToTest.length < 2) {
                testContentArea.innerHTML = "<p>Eşleştirme testi için yeterli öğrenilmemiş kelime (en az 2) bulunmuyor.</p>";
                submitTestButton.style.display = 'none';
                return;
            }

            const englishColumnSource = wordsToTest.map(w => w.english);
            const turkishColumnSource = wordsToTest.map(w => w.turkish);

            // Create a copy and shuffle for display
            const englishDisplayColumn = shuffleArray([...englishColumnSource]); 
            const turkishDisplayColumn = shuffleArray([...turkishColumnSource]);


            let html = `<div class="match-container">
                            <div class="match-column" id="english-match-column"><h3>İngilizce (Sürükle)</h3></div>
                            <div class="match-column" id="turkish-match-column"><h3>Türkçe (Hedefler)</h3></div>
                        </div>`;
            testContentArea.innerHTML = html;

            const engColEl = document.getElementById('english-match-column');
            const turColEl = document.getElementById('turkish-match-column');

            // Store correct pairs for checking
            currentTest.pairs = wordsToTest.map(w => ({ english: w.english, turkish: w.turkish }));


            englishDisplayColumn.forEach((engWord, i) => {
                const engItem = document.createElement('div');
                engItem.className = 'match-item';
                engItem.textContent = engWord;
                engItem.draggable = true;
                engItem.id = `eng-match-${i}`;
                engItem.dataset.english = engWord; // Store the actual English word
                engItem.addEventListener('dragstart', (e) => { draggedItem = e.target; });
                engColEl.appendChild(engItem);
            });

            turkishDisplayColumn.forEach((turWord, i) => { 
                const targetDiv = document.createElement('div');
                targetDiv.className = 'match-target';
                targetDiv.id = `tur-match-target-${i}`;
                targetDiv.dataset.turkishTarget = turWord; // Store the Turkish word this slot represents
                
                targetDiv.addEventListener('dragover', (e) => { e.preventDefault(); e.target.classList.add('drag-over'); });
                targetDiv.addEventListener('dragleave', (e) => { e.target.classList.remove('drag-over'); });

                targetDiv.addEventListener('drop', (e) => {
                    e.preventDefault();
                    e.target.classList.remove('drag-over');
                    // Sadece match-item veya altındaki span varsa boş sayılır.
                    // span kaldırıldığında veya üzerine bir eleman bırakıldığında slot dolu kabul edilir.
                    const existingItem = e.target.querySelector('.match-item');
                    if (draggedItem && e.target.classList.contains('match-target') && !existingItem) {
                        // Hedefteki placeholder yazısını kaldır
                        const placeholder = e.target.querySelector('span');
                        if(placeholder) placeholder.style.display = 'none';
                        e.target.appendChild(draggedItem);
                        draggedItem = null;
                    }
                });
                // Add a placeholder text to the target
                const targetTextNode = document.createElement('span');
                targetTextNode.textContent = turWord; // Show the Turkish word in the target
                targetTextNode.style.color = '#aaa'; // Make it look like a placeholder
                targetTextNode.style.fontStyle = 'italic';
                targetDiv.appendChild(targetTextNode);

                turColEl.appendChild(targetDiv);
            });
        }


        function submitTest() {
            if (!currentTest) return;
            let score = 0;
            let totalQuestions = 0;

            if (currentTest.type === 'multiple-choice') {
                totalQuestions = currentTest.questions.length;
                const questionContainers = testContentArea.querySelectorAll('.question-container');
                questionContainers.forEach((qDiv, index) => {
                    const selectedOption = qDiv.querySelector(`input[name="q${index}"]:checked`);
                    const feedbackEl = document.createElement('div');
                    feedbackEl.className = 'feedback';
                    if (selectedOption) {
                        if (selectedOption.value === qDiv.dataset.correctAnswer) {
                            score++;
                            feedbackEl.textContent = "Doğru!";
                            feedbackEl.classList.add('correct');
                        } else {
                            feedbackEl.textContent = `Yanlış. Doğru cevap: ${qDiv.dataset.correctAnswer}`;
                            feedbackEl.classList.add('incorrect');
                        }
                    } else {
                        feedbackEl.textContent = `Cevaplanmadı. Doğru cevap: ${qDiv.dataset.correctAnswer}`;
                        feedbackEl.classList.add('incorrect');
                    }
                    qDiv.appendChild(feedbackEl);
                    qDiv.querySelectorAll('input').forEach(inp => inp.disabled = true);
                });
            } else if (currentTest.type === 'matching') {
                totalQuestions = currentTest.pairs.length;
                const targets = testContentArea.querySelectorAll('.match-target');
                targets.forEach(targetEl => {
                    const droppedItem = targetEl.querySelector('.match-item'); // The English word div
                    const targetTurkishWord = targetEl.dataset.turkishTarget; // The Turkish word this slot IS
                    const feedbackEl = document.createElement('div');
                    feedbackEl.className = 'feedback';

                    // Hedefteki placeholder'ı görünür yap veya kaldır (feedback eklemeden önce)
                    const placeholder = targetEl.querySelector('span');
                    if(placeholder && droppedItem) placeholder.style.display = 'none';
                    else if(placeholder && !droppedItem) placeholder.style.display = ''; // Eğer boş kalmışsa görünür yap

                    if (droppedItem) {
                        const droppedEnglishWord = droppedItem.dataset.english;
                        // Find the correct Turkish partner for the dropped English word
                        const correctPair = currentTest.pairs.find(p => p.english === droppedEnglishWord);
                        
                        if (correctPair && correctPair.turkish === targetTurkishWord) {
                            score++;
                            feedbackEl.textContent = "Doğru eşleşme!";
                            feedbackEl.classList.add('correct');
                        } else {
                            feedbackEl.textContent = `Yanlış. "${droppedEnglishWord}" için doğru eşleşme "${correctPair ? correctPair.turkish : 'Bilinmiyor'}" olmalıydı.`;
                            feedbackEl.classList.add('incorrect');
                        }
                    } else { // Empty target
                        feedbackEl.textContent = `Boş bırakıldı. (Doğru eşleşme: ${targetTurkishWord})`; // Boş bırakılan yerdeki Türkçe kelimeyi göster
                        feedbackEl.classList.add('incorrect');
                    }
                    targetEl.appendChild(feedbackEl);
                });
                document.querySelectorAll('.match-item').forEach(item => item.draggable = false); // Eşleşen kelimeleri sürüklenemez yap

            }

            testResultsArea.innerHTML = `Test Tamamlandı! Sonucunuz: ${score} / ${totalQuestions}`;
            submitTestButton.style.display = 'none';
            currentTest = null;
        }
		
        // --- UYGULAMA BAŞLANGICI ---
        document.addEventListener('DOMContentLoaded', () => {
            // DOM elementlerini burada ata
            flashcardEl = document.getElementById('flashcard');
            cardFrontTextEl = document.getElementById('card-front-text');
            cardBackTextEl = document.getElementById('card-back-text');
            prevCardButton = document.getElementById('prev-card-button');
            nextCardButton = document.getElementById('next-card-button');
            currentWordInfoEl = document.getElementById('current-word-info');
            toggleLearnedButton = document.getElementById('toggleLearnedButton');
            filterLearnedCheckbox = document.getElementById('filterLearned');
            noWordsMessageEl = document.getElementById('no-words-message');
            folderSelectEl = document.getElementById('folder-select');
            addToFolderSelectEl = document.getElementById('add-to-folder-select');
            bulkAddToFolderSelectEl = document.getElementById('bulk-add-to-folder-select');
            testFolderSelectEl = document.getElementById('test-folder-select');
            emailRecipientInput = document.getElementById('email-recipient');
            reportTypeSelectEl = document.getElementById('report-type-select');
            emailReportOutputEl = document.getElementById('email-report-output');
            langDirToggleEl = document.getElementById('language-direction-toggle');
            testContentArea = document.getElementById('test-content-area');
            testResultsArea = document.getElementById('test-results');
            submitTestButton = document.getElementById('submit-test-button');
            newFolderNameInputEl = document.getElementById('new-folder-name');
            bulkAddWordsAreaEl = document.getElementById('bulk-add-words-area');
            
            htmlTabButtons = document.querySelectorAll(".tabs .tab-button"); // Doğru seçici
            htmlTabContents = document.querySelectorAll(".tab-content");

            // Sekme butonlarına event listener ekle
            htmlTabButtons.forEach(button => {
                button.addEventListener('click', function(event) {
                    const tabId = this.dataset.tab; // HTML'e data-tab attribute'u eklendi
                    if (tabId) {
                        openTab(tabId, this); // Tıklanan butonu da gönder
                    } else {
                        console.error("Butonda data-tab attribute'u bulunamadı:", this);
                    }
                });
            });

            if(flashcardEl) {
                flashcardEl.addEventListener('click', () => { 
                    if (currentVocabularyView && currentVocabularyView.length > 0 && currentVocabularyView[currentCardIndexInView]) { 
                        flashcardEl.classList.toggle('flipped'); 
                    }
                });
            }
            if(toggleLearnedButton) {
                toggleLearnedButton.addEventListener('click', () => { 
                    if (!currentVocabularyView || currentVocabularyView.length === 0 || !currentVocabularyView[currentCardIndexInView]) return;
                    
                    const currentDisplayedWord = currentVocabularyView[currentCardIndexInView];
                    const activeFolderWords = vocabularyData.folders[vocabularyData.activeFolder] || [];
                    
                    // currentDisplayedWord'ün aslında hangi kelime olduğunu bul
                    const originalWordInFolder = activeFolderWords.find(
                        word => word.english === currentDisplayedWord.english && word.turkish === currentDisplayedWord.turkish
                    );

                    if (originalWordInFolder) {
                        originalWordInFolder.isLearned = !originalWordInFolder.isLearned;
                        if(originalWordInFolder.isLearned) {
                            originalWordInFolder.learnedTimestamp = Date.now();
                        } else { delete originalWordInFolder.learnedTimestamp; }
                        
                        // Güncellenmiş öğrenme durumunu currentDisplayedWord'e de yansıt
                        currentDisplayedWord.isLearned = originalWordInFolder.isLearned;
                        currentDisplayedWord.learnedTimestamp = originalWordInFolder.learnedTimestamp;

                        updateToggleLearnedButton(originalWordInFolder.isLearned);
                        
                        if (filterLearnedCheckbox && filterLearnedCheckbox.checked && originalWordInFolder.isLearned) {
                            // Eğer öğrenildi olarak işaretlendi ve filtre aktifse, listeden çıkar
                            updateCurrentVocabularyView(); 
                            if (currentCardIndexInView >= currentVocabularyView.length && currentVocabularyView.length > 0) {
                                currentCardIndexInView = currentVocabularyView.length - 1;
                            } else if (currentVocabularyView.length === 0) { 
                                currentCardIndexInView = 0; 
                            }
                            loadCard(currentCardIndexInView);
                        } else {
                            // Filtre kapalıysa veya öğrenilmedi olarak işaretlendiyse sadece kartı güncelle
                            loadCard(currentCardIndexInView);
                        }
                        saveAppState();
                    } else {
                        console.error("ToggleLearnedButton: Orijinal kelime bulunamadı!");
                    }
                });
            }

            document.addEventListener('keydown', function(event) {
                const activeTab = document.querySelector('.tab-content.active');
                if (!activeTab) return;
                const activeTabId = activeTab.id;

                // Input, textarea veya select içindeyse kısayolları devre dışı bırak
                if (event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA' || event.target.tagName === 'SELECT') {
                    return; 
                }

                if (activeTabId === 'learnTab') {
                    switch (event.key) {
                        case ' ': 
                            event.preventDefault(); 
                            if (flashcardEl && currentVocabularyView && currentVocabularyView.length > 0 && currentVocabularyView[currentCardIndexInView]) { 
                                flashcardEl.classList.toggle('flipped'); 
                            } 
                            break;
                        case 'ArrowLeft': if (prevCardButton && !prevCardButton.disabled) prevCard(); break;
                        case 'ArrowRight': if (nextCardButton && !nextCardButton.disabled) nextCard(); break;
                        case 'Enter': // Enter'a basınca öğrendim butonuna tıkla
                            event.preventDefault(); // Varsayılan Enter davranışını engelle (örn. form gönderme)
                            if (toggleLearnedButton && !toggleLearnedButton.disabled) { toggleLearnedButton.click(); } 
                            break;
                    }
                }
            });


            loadAppState(); // Veriyi yükle ve DOM elemanlarını güncel

            // İlk sekmeyi aç (data-tab attribute'una göre ilk butonu bul)
            const firstTabButton = document.querySelector(".tabs .tab-button");
            if (firstTabButton && firstTabButton.dataset.tab) {
                openTab(firstTabButton.dataset.tab, firstTabButton);
            } else { // Fallback
                openTab('learnTab');
            }
            // `openTab` çağrısı zaten `populateFolderSelects` ve `loadCard` çağrılarını içerecektir.
            // Bu nedenle ekstra `populateFolderSelects()` veya `loadCard()` burada çağrılmasına gerek yok.
        });
        // Önceki fonksiyonların gövdelerini buraya ekleyin (saveAppState, loadAppState, clearAllData, ...)
        // ... (Tüm diğer JS fonksiyonlarınız) ...
    </script>
</body>
</html>